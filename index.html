<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Gym Log App</title>
    <!-- Supabase JavaScript library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Auth View -->
        <div id="auth-view" class="max-w-md w-full">
            <div class="bg-white p-8 rounded-xl shadow-md text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Gym Log App</h1>
                <div id="status" class="text-gray-500 mb-4">Checking login status...</div>
                <button id="loginBtn" class="w-full bg-[#1877F2] hover:bg-[#166FE5] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-colors">
                    <svg aria-hidden="true" class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.676 0H1.324C.593 0 0 .593 0 1.324v21.352C0 23.407.593 24 1.324 24h11.494v-9.294H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12V24h6.116c.73 0 1.323-.593 1.323-1.324V1.324C24 .593 23.407 0 22.676 0Z" fill="white"></path></svg>
                    <span>Log In with Facebook</span>
                </button>
            </div>
        </div>

        <!-- App View -->
        <div id="app-view" class="max-w-xl w-full hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div id="userInfo" class="text-xl font-bold text-gray-800"></div>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Log Out</button>
                </div>

                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
                    <div class="space-y-4">
                        <button id="startWorkoutBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Start New Blank Workout</button>
                        <button id="showHistoryBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">View Workout History</button>
                        <button id="showProgressBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">View Progress</button>
                        <div id="routines-section">
                             <h3 class="text-xl font-bold mt-6 mb-2">My Routines</h3>
                             <div id="routines-list" class="space-y-2"><p>Loading routines...</p></div>
                        </div>
                    </div>
                </div>

                <!-- Live Workout Session View -->
                <div id="live-session-view" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Live Workout</h2>
                    <div id="session-exercises-list" class="space-y-4 mb-6"></div>
                    <form id="add-exercise-form" class="space-y-4 bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg">Add Exercise</h3>
                        <div>
                            <label for="exercise-select" class="block text-sm font-medium text-gray-700">Exercise</label>
                            <select id="exercise-select" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                                <input type="number" id="weight" step="0.5" required class="mt-1 block w-full px-3 py-2 border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="reps" class="block text-sm font-medium text-gray-700">Reps</label>
                                <input type="number" id="reps" required class="mt-1 block w-full px-3 py-2 border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="sets" class="block text-sm font-medium text-gray-700">Sets</label>
                                <input type="number" id="sets" required class="mt-1 block w-full px-3 py-2 border-gray-300 rounded-md">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Add to Workout</button>
                    </form>
                    <div class="mt-6 flex gap-4">
                        <button id="finishWorkoutBtn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition-colors">Finish & Save Workout</button>
                        <button id="cancelWorkoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancel Workout</button>
                    </div>
                </div>
                
                <!-- Workout History View -->
                <div id="history-view" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Workout History</h2>
                        <button class="back-to-dash-btn bg-gray-200 py-2 px-4 rounded-lg">Back</button>
                    </div>
                    <div class="flex gap-4 mb-4">
                        <div>
                            <label for="history-year-select" class="block text-sm font-medium text-gray-700">Year</label>
                            <select id="history-year-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label for="history-month-select" class="block text-sm font-medium text-gray-700">Month</label>
                            <select id="history-month-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-2"></div>
                </div>

                <!-- Progress View -->
                <div id="progress-view" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Progress</h2>
                        <button class="back-to-dash-btn bg-gray-200 py-2 px-4 rounded-lg">Back</button>
                    </div>
                    <div>
                        <label for="progress-exercise-select" class="block text-sm font-medium text-gray-700">Select Exercise to View Progress</label>
                        <select id="progress-exercise-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="mt-4" style="height: 300px;">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Routine Modal -->
        <div id="save-routine-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
             <div id="modal-content" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all scale-95">
                <h2 class="text-xl font-bold mb-4">Save Workout as Routine</h2>
                <p class="mb-4 text-sm text-gray-600">Save the exercises from this session as a new reusable template.</p>
                <form id="save-routine-form">
                    <div>
                        <label for="routine-name" class="block text-sm font-medium text-gray-700">Routine Name</label>
                        <input type="text" id="routine-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div id="save-routine-message" class="text-sm mt-4"></div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" id="skip-save-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Don't Save Template</button>
                        <button type="submit" id="save-routine-submit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                           <span id="save-routine-btn-text">Save Routine</span>
                           <svg id="save-routine-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                           </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
             <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h2 id="confirmation-title" class="text-xl font-bold mb-4">Are you sure?</h2>
                <p id="confirmation-message" class="mb-6 text-gray-600">This action cannot be undone.</p>
                <div class="flex justify-end gap-4">
                    <button id="confirmation-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="confirmation-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & CLIENT ---
        const SUPABASE_URL = 'https://fvjkqfrsxraivxomdywc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2amtxZnJzeHJhaXZ4b21keXdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzg2MzMsImV4cCI6MjA2OTk1NDYzM30.QqimcxoaZ0WHT_jvAlGjyWZ6lVbJ9g9iOyyDrUh-r24';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- DOM Element References ---
        const authView = document.getElementById('auth-view'), appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
        const statusDiv = document.getElementById('status'), userInfoDiv = document.getElementById('userInfo');
        const dashboardView = document.getElementById('dashboard-view'), liveSessionView = document.getElementById('live-session-view');
        const historyView = document.getElementById('history-view'), progressView = document.getElementById('progress-view');
        const startWorkoutBtn = document.getElementById('startWorkoutBtn');
        const showHistoryBtn = document.getElementById('showHistoryBtn'), showProgressBtn = document.getElementById('showProgressBtn');
        const backToDashBtns = document.querySelectorAll('.back-to-dash-btn');
        const routinesList = document.getElementById('routines-list');
        const historyList = document.getElementById('history-list');
        const progressExerciseSelect = document.getElementById('progress-exercise-select');
        const progressChartCanvas = document.getElementById('progress-chart');
        const finishWorkoutBtn = document.getElementById('finishWorkoutBtn');
        const cancelWorkoutBtn = document.getElementById('cancelWorkoutBtn');
        const addExerciseForm = document.getElementById('add-exercise-form');
        const exerciseSelect = document.getElementById('exercise-select');
        const saveRoutineModal = document.getElementById('save-routine-modal');
        const saveRoutineForm = document.getElementById('save-routine-form');
        const skipSaveBtn = document.getElementById('skip-save-btn');
        let progressChart = null;

        // --- APP STATE ---
        let masterExerciseList = [], userRoutines = [], currentSessionLogs = [];

        // --- AUTH LOGIC ---
        const logInWithFacebook = () => _supabase.auth.signInWithOAuth({ provider: 'facebook', options: { redirectTo: window.location.href } });
        const logout = () => _supabase.auth.signOut();

        // --- UI VIEW MANAGEMENT ---
        const showView = (view) => {
            [authView, appView, dashboardView, liveSessionView, historyView, progressView, saveRoutineModal, document.getElementById('confirmation-modal')].forEach(el => el.classList.add('hidden'));
            if (view === 'login') authView.classList.remove('hidden');
            else {
                appView.classList.remove('hidden');
                if (view === 'dashboard') dashboardView.classList.remove('hidden');
                if (view === 'live-session') liveSessionView.classList.remove('hidden');
                if (view === 'history') historyView.classList.remove('hidden');
                if (view === 'progress') progressView.classList.remove('hidden');
            }
        };
        
        // --- UTILITY FUNCTIONS ---
        const showConfirmation = (title, message, onConfirm) => {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const cancelBtn = document.getElementById('confirmation-cancel-btn');

            const confirmHandler = () => {
                onConfirm();
                modal.classList.add('hidden');
            };

            const cancelHandler = () => {
                modal.classList.add('hidden');
            };
            
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });

            modal.classList.remove('hidden');
        };

        window.toggleWorkoutDetails = (headerElement) => {
            const detailsDiv = headerElement.nextElementSibling;
            const button = headerElement.querySelector('button');
            const isHidden = detailsDiv.classList.toggle('hidden');
            button.textContent = isHidden ? 'Expand' : 'Collapse';
        };

        // --- DATA FETCHING ---
        const fetchInitialData = async () => {
            await Promise.all([fetchMasterExerciseList(), fetchUserRoutines()]);
        };
        
        const fetchMasterExerciseList = async () => {
            const { data, error } = await _supabase.from('exercises').select('id, name').order('name');
            if (error) console.error('Error fetching exercises:', error);
            else {
                masterExerciseList = data;
                populateExerciseDropdown();
            }
        };

        const fetchUserRoutines = async () => {
            const { data, error } = await _supabase.from('routines').select(`id, name, routine_items ( exercise_id )`);
            if (error) console.error('Error fetching routines:', error);
            else {
                userRoutines = data;
                renderRoutines();
            }
        };

        const initializeHistoryView = async () => {
            populateHistoryFilters();
            const yearSelect = document.getElementById('history-year-select');
            const monthSelect = document.getElementById('history-month-select');

            yearSelect.addEventListener('change', () => fetchWorkoutHistory(yearSelect.value, monthSelect.value));
            monthSelect.addEventListener('change', () => fetchWorkoutHistory(yearSelect.value, monthSelect.value));

            await fetchWorkoutHistory(yearSelect.value, monthSelect.value);
            showView('history');
        };

        const fetchWorkoutHistory = async (year, month) => {
            historyList.innerHTML = '<p>Loading history...</p>';

            const firstDay = `${year}-${String(month).padStart(2, '0')}-01`;
            const lastDayOfMonth = new Date(year, month, 0).getDate();
            const lastDay = `${year}-${String(month).padStart(2, '0')}-${String(lastDayOfMonth).padStart(2, '0')}`;

            const { data, error } = await _supabase
                .from('exercise_logs')
                .select(`*, exercises (name)`)
                .gte('log_date', firstDay)
                .lte('log_date', lastDay)
                .order('log_date', { ascending: false });

            if (error) {
                historyList.innerHTML = '<p class="text-red-500">Error fetching history.</p>';
                return console.error("Error fetching history:", error);
            }
            
            const workoutsByDate = data.reduce((acc, log) => {
                const date = log.log_date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(log);
                return acc;
            }, {});

            renderWorkoutHistory(workoutsByDate);
        };

        // --- RENDERING LOGIC ---
        const populateExerciseDropdown = () => {
            exerciseSelect.innerHTML = '<option value="">Select an exercise...</option>';
            masterExerciseList.forEach(ex => exerciseSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`);
        };

        const populateHistoryFilters = () => {
            const yearSelect = document.getElementById('history-year-select');
            const monthSelect = document.getElementById('history-month-select');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            yearSelect.innerHTML = '';
            for (let i = currentYear; i >= currentYear - 5; i--) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            yearSelect.value = currentYear;

            monthSelect.innerHTML = '';
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            for (let i = 0; i < 12; i++) {
                monthSelect.innerHTML += `<option value="${i + 1}">${monthNames[i]}</option>`;
            }
            monthSelect.value = currentMonth;
        };

        const renderRoutines = () => {
            if (userRoutines.length === 0) {
                routinesList.innerHTML = '<p class="text-gray-500">No routines saved yet.</p>';
                return;
            }
            routinesList.innerHTML = '';
            userRoutines.forEach(routine => {
                const routineEl = document.createElement('div');
                routineEl.className = 'flex items-center gap-2';
                routineEl.innerHTML = `
                    <button class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-left">${routine.name}</button>
                    <button onclick="handleDeleteRoutine(${routine.id}, '${routine.name}')" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0 text-lg font-bold">&times;</button>
                `;
                routineEl.querySelector('button:first-child').onclick = () => loadRoutine(routine.id);
                routinesList.appendChild(routineEl);
            });
        };

        const renderCurrentSession = () => {
            const sessionListEl = document.getElementById('session-exercises-list');
            if (!sessionListEl) return;
            if (currentSessionLogs.length === 0) {
                sessionListEl.innerHTML = '<p class="text-gray-500">No exercises added yet.</p>';
                return;
            }
            sessionListEl.innerHTML = '';
            currentSessionLogs.forEach((log, index) => {
                const exercise = masterExerciseList.find(ex => ex.id == log.exercise_id);
                const isCompleted = !!log.completed_at;
                const logEl = document.createElement('div');
                logEl.className = `p-3 rounded-md ${isCompleted ? 'bg-green-100' : 'bg-gray-200'}`;
                
                let completionHTML = '';
                if (isCompleted) {
                    completionHTML = `<div class="text-sm text-green-700 font-semibold mt-2">Completed: ${new Date(log.completed_at).toLocaleTimeString('en-NZ')}</div>`;
                } else {
                    completionHTML = `<button onclick="markExerciseAsComplete(${index})" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm">Complete</button>`;
                }

                logEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-bold">${exercise ? exercise.name : 'Unknown Exercise'}</p>
                        <button onclick="removeExerciseFromSession(${index})" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-xs">Weight (kg)</label>
                            <input type="number" step="0.5" value="${log.weight}" data-index="${index}" data-field="weight" class="w-full p-1 border rounded-md" ${isCompleted ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="text-xs">Reps</label>
                            <input type="number" value="${log.reps}" data-index="${index}" data-field="reps" class="w-full p-1 border rounded-md" ${isCompleted ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="text-xs">Sets</label>
                            <input type="number" value="${log.sets}" data-index="${index}" data-field="sets" class="w-full p-1 border rounded-md" ${isCompleted ? 'disabled' : ''}>
                        </div>
                    </div>
                    ${completionHTML}
                `;
                sessionListEl.appendChild(logEl);
            });
        };

        const renderWorkoutHistory = (workoutsByDate) => {
            historyList.innerHTML = '';
            if (Object.keys(workoutsByDate).length === 0) {
                historyList.innerHTML = '<p>No workouts found for this period.</p>';
                return;
            }

            for (const date in workoutsByDate) {
                const dateEl = document.createElement('div');
                dateEl.className = 'bg-white p-4 rounded-lg shadow-sm';
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-NZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                let exercisesHTML = workoutsByDate[date].map(log => {
                    const completedTime = log.completed_at ? `at ${new Date(log.completed_at).toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' })}` : '';
                    return `
                    <div class="flex justify-between border-t pt-2 mt-2 first:border-t-0 first:mt-0 first:pt-0">
                        <div>
                           <p class="font-semibold">${log.exercises.name}</p>
                           <p class="text-xs text-gray-500">${completedTime}</p>
                        </div>
                        <p class="text-right">${log.sets}x${log.reps} @ ${log.weight}kg</p>
                    </div>
                `}).join('');

                dateEl.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleWorkoutDetails(this)">
                        <h3 class="font-bold text-lg">${formattedDate}</h3>
                        <button class="text-blue-500 text-sm font-medium pointer-events-none">Expand</button>
                    </div>
                    <div class="mt-2 pt-2 border-t hidden">
                        ${exercisesHTML}
                    </div>
                `;
                historyList.appendChild(dateEl);
            }
        };

        // --- SESSION & ROUTINE LOGIC ---
        const startNewWorkout = () => {
            currentSessionLogs = [];
            renderCurrentSession();
            showView('live-session');
        };
        
        const markExerciseAsComplete = (index) => {
            const log = currentSessionLogs[index];
            if (!log) return;
            // Update the log with the latest values from the input fields before marking as complete
            log.weight = document.querySelector(`[data-index='${index}'][data-field='weight']`).value;
            log.reps = document.querySelector(`[data-index='${index}'][data-field='reps']`).value;
            log.sets = document.querySelector(`[data-index='${index}'][data-field='sets']`).value;
            
            log.completed_at = new Date().toISOString();
            renderCurrentSession();
        };

        const loadRoutine = async (routineId) => {
            const routine = userRoutines.find(r => r.id === routineId);
            if (!routine) return;

            const exerciseIds = routine.routine_items.map(item => item.exercise_id);
            
            if (exerciseIds.length === 0) {
                currentSessionLogs = [];
                renderCurrentSession();
                showView('live-session');
                return;
            }

            const { data, error } = await _supabase
                .from('exercise_logs')
                .select('exercise_id, weight, reps, sets, log_date')
                .in('exercise_id', exerciseIds)
                .order('log_date', { ascending: false });

            if (error) {
                console.error('Error fetching last logs:', error);
                return;
            }

            const lastLogsMap = new Map();
            for (const log of data) {
                if (!lastLogsMap.has(log.exercise_id)) {
                    lastLogsMap.set(log.exercise_id, log);
                }
            }
            const lastLogs = Array.from(lastLogsMap.values());

            currentSessionLogs = exerciseIds.map(exId => {
                const lastLog = lastLogs.find(log => log.exercise_id == exId);
                return {
                    exercise_id: exId,
                    weight: lastLog?.weight || 0,
                    reps: lastLog?.reps || 0,
                    sets: lastLog?.sets || 0,
                    completed_at: null // Ensure it's null for a new session
                };
            });

            renderCurrentSession();
            showView('live-session');
        };
        
        const removeExerciseFromSession = (index) => {
            currentSessionLogs.splice(index, 1);
            renderCurrentSession();
        };

        const handleAddExercise = (event) => {
            event.preventDefault();
            const exerciseId = document.getElementById('exercise-select').value;
            if (!exerciseId) return;
            currentSessionLogs.push({
                exercise_id: exerciseId,
                weight: document.getElementById('weight').value,
                reps: document.getElementById('reps').value,
                sets: document.getElementById('sets').value,
                completed_at: null
            });
            renderCurrentSession();
            addExerciseForm.reset();
        };

        const finishWorkout = async () => {
            if (currentSessionLogs.length === 0) {
                showConfirmation("Empty Workout", "Cannot save an empty workout. Do you want to discard it?", () => showView('dashboard'));
                return;
            }
            updateSessionLogsFromUI();
            saveRoutineModal.classList.remove('hidden');
        };
        
        const updateSessionLogsFromUI = () => {
            currentSessionLogs.forEach((log, index) => {
                // Only update if not already completed
                if (!log.completed_at) {
                    log.weight = document.querySelector(`[data-index='${index}'][data-field='weight']`).value;
                    log.reps = document.querySelector(`[data-index='${index}'][data-field='reps']`).value;
                    log.sets = document.querySelector(`[data-index='${index}'][data-field='sets']`).value;
                }
            });
        };

        const saveWorkoutLogs = async () => {
            const user = (await _supabase.auth.getUser()).data.user;
            const logsToInsert = currentSessionLogs.map(log => ({ 
                user_id: user.id, 
                log_date: new Date().toISOString().split('T')[0],
                exercise_id: log.exercise_id,
                weight: log.weight,
                reps: log.reps,
                sets: log.sets,
                completed_at: log.completed_at
            }));
            const { error } = await _supabase.from('exercise_logs').insert(logsToInsert);
            if (error) {
                console.error('Error saving workout logs:', error);
                throw new Error('Failed to save workout logs.');
            }
        };

        const handleSaveRoutine = async (event) => {
            event.preventDefault();
            const routineNameInput = document.getElementById('routine-name');
            const routineName = routineNameInput.value.trim();
            
            const messageEl = document.getElementById('save-routine-message');
            const submitBtn = document.getElementById('save-routine-submit-btn');
            const skipBtn = document.getElementById('skip-save-btn');
            const btnText = document.getElementById('save-routine-btn-text');
            const spinner = document.getElementById('save-routine-spinner');

            messageEl.textContent = '';
            if (!routineName) {
                messageEl.textContent = 'Please enter a routine name.';
                messageEl.className = 'text-sm mt-4 text-red-600';
                return;
            }

            submitBtn.disabled = true;
            skipBtn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');

            const user = (await _supabase.auth.getUser()).data.user;

            try {
                const { data: newRoutine, error: routineError } = await _supabase
                    .from('routines').insert({ name: routineName, user_id: user.id }).select().single();
                if (routineError) throw routineError;

                const uniqueExerciseIds = [...new Set(currentSessionLogs.map(log => log.exercise_id))];
                const itemsToInsert = uniqueExerciseIds.map(exId => ({ routine_id: newRoutine.id, exercise_id: exId }));
                if (itemsToInsert.length > 0) {
                    const { error: itemsError } = await _supabase.from('routine_items').insert(itemsToInsert);
                    if (itemsError) throw itemsError;
                }
                
                await saveWorkoutLogs();

                messageEl.textContent = 'Routine and workout saved successfully!';
                messageEl.className = 'text-sm mt-4 text-green-600';
                await fetchUserRoutines();
                
                setTimeout(() => {
                    saveRoutineModal.classList.add('hidden');
                    showView('dashboard');
                    routineNameInput.value = '';
                    submitBtn.disabled = false;
                    skipBtn.disabled = false;
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    messageEl.textContent = '';
                }, 1500);

            } catch (error) {
                console.error('Failed to save routine:', error);
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'text-sm mt-4 text-red-600';
                submitBtn.disabled = false;
                skipBtn.disabled = false;
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        };

        const handleSkipSave = async () => {
            const messageEl = document.getElementById('save-routine-message');
            const submitBtn = document.getElementById('save-routine-submit-btn');
            const skipBtn = document.getElementById('skip-save-btn');
            const routineNameInput = document.getElementById('routine-name');

            submitBtn.disabled = true;
            skipBtn.disabled = true;
            messageEl.textContent = 'Saving workout...';
            messageEl.className = 'text-sm mt-4 text-gray-600';

            try {
                await saveWorkoutLogs();
                messageEl.textContent = 'Workout saved successfully!';
                messageEl.className = 'text-sm mt-4 text-green-600';

                setTimeout(() => {
                    saveRoutineModal.classList.add('hidden');
                    showView('dashboard');
                    routineNameInput.value = '';
                    submitBtn.disabled = false;
                    skipBtn.disabled = false;
                    messageEl.textContent = '';
                }, 1500);

            } catch (error) {
                console.error('Failed to save workout:', error);
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'text-sm mt-4 text-red-600';
                submitBtn.disabled = false;
                skipBtn.disabled = false;
            }
        };

        const handleDeleteRoutine = async (routineId, routineName) => {
            showConfirmation(
                'Delete Routine?',
                `Are you sure you want to delete the routine "${routineName}"? This cannot be undone.`,
                async () => {
                    const { error } = await _supabase.from('routines').delete().match({ id: routineId });
                    if (error) {
                        console.error('Error deleting routine:', error);
                    } else {
                        console.log('Routine deleted.');
                        fetchUserRoutines();
                    }
                }
            );
        };

        // --- PROGRESS CHART LOGIC ---
        const showProgress = () => {
            progressExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>';
            masterExerciseList.forEach(ex => {
                progressExerciseSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
            });
            if (progressChart) progressChart.destroy();
            showView('progress');
        };

        const fetchAndDrawProgressChart = async (exerciseId) => {
            if (!exerciseId) {
                if(progressChart) progressChart.destroy();
                return;
            }

            const { data, error } = await _supabase
                .from('exercise_logs')
                .select('log_date, weight')
                .eq('exercise_id', exerciseId)
                .order('log_date', { ascending: true });
            
            if (error) return console.error('Error fetching progress data:', error);

            const labels = data.map(log => new Date(log.log_date + 'T00:00:00').toLocaleDateString('en-NZ'));
            const weights = data.map(log => log.weight);

            if (progressChart) progressChart.destroy();
            progressChart = new Chart(progressChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight Lifted (kg)',
                        data: weights,
                        borderColor: 'rgb(13, 148, 136)',
                        backgroundColor: 'rgba(13, 148, 136, 0.5)',
                        tension: 0.1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', logInWithFacebook);
        logoutBtn.addEventListener('click', logout);
        startWorkoutBtn.addEventListener('click', startNewWorkout);
        showHistoryBtn.addEventListener('click', initializeHistoryView);
        showProgressBtn.addEventListener('click', showProgress);
        backToDashBtns.forEach(btn => btn.addEventListener('click', () => showView('dashboard')));
        progressExerciseSelect.addEventListener('change', (e) => fetchAndDrawProgressChart(e.target.value));
        finishWorkoutBtn.addEventListener('click', finishWorkout);
        cancelWorkoutBtn.addEventListener('click', () => {
            showConfirmation(
                'Cancel Workout?',
                'Are you sure you want to cancel this workout? All unsaved progress will be lost.',
                () => showView('dashboard')
            );
        });
        addExerciseForm.addEventListener('submit', handleAddExercise);
        saveRoutineForm.addEventListener('submit', handleSaveRoutine);
        skipSaveBtn.addEventListener('click', handleSkipSave);

        // --- MAIN AUTH STATE LISTENER ---
        _supabase.auth.onAuthStateChange(async (event, session) => {
            if (session && session.user) {
                userInfoDiv.textContent = `Hello, ${session.user.user_metadata?.full_name || session.user.email}`;
                await fetchInitialData();
                showView('dashboard');
            } else {
                showView('login');
            }
        });
    </script>
</body>
</html>
